<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>مسابقة الكلية</title>
  <!-- خط Cairo -->
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #e3f2fd, #ffffff);
      font-family: 'Cairo', sans-serif;
      color: #0d47a1;
    }

    .question-card {
      max-width: 700px;
      margin: 2rem auto;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0, 51, 102, 0.15);
      border: 1px solid #bbdefb;
    }

    .option-btn {
      background-color: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #90caf9;
      font-weight: 600;
      transition: all 0.2s;
      text-align: right;
    }

    .option-btn:hover {
      background-color: #bbdefb;
    }

    .btn-success {
      background-color: #4caf50 !important;
      border-color: #4caf50 !important;
    }

    .btn-danger {
      background-color: #f44336 !important;
      border-color: #f44336 !important;
    }

    footer {
      text-align: center;
      padding: 1rem 0;
      background: #0d47a1;
      color: white;
      margin-top: 3rem;
      font-size: 0.95rem;
    }

    .form-select,
    .form-control {
      border: 1px solid #90caf9;
      background-color: #f5fbff;
    }

    .btn-primary {
      background-color: #1976d2;
      border-color: #1976d2;
    }

    .btn-primary:hover {
      background-color: #0d47a1;
      border-color: #0d47a1;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="question-card p-4 bg-white">
      <!-- Intro Form -->
      <div id="intro" class="text-center">
        <h3 class="mb-4">مسابقة الكلية</h3>
        <form id="studentInfo">
          <div class="mb-3 text-end">
            <input type="text" class="form-control" id="name" placeholder="اسمك الكامل" required>
          </div>
          <div class="mb-3 text-end">
            <input type="text" class="form-control" id="department" placeholder="القسم" required>
          </div>
          <div class="mb-3 text-end">
            <select class="form-select" id="level" required>
              <option value="">اختر المرحلة الدراسي</option>
              <option value="الأولى">الأولى</option>
              <option value="الثانية">الثانية</option>
              <option value="الثالثة">الثالثة</option>
              <option value="الرابعة">الرابعة</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">ابدأ الاختبار</button>
        </form>
      </div>

      <!-- Quiz Area -->
      <div id="quiz" style="display:none;">
        <div class="text-end mb-3">
          <small id="questionCounter" class="text-muted"></small>
        </div>
        <h4 id="questionText" class="text-end mb-4"></h4>
        <div id="options"></div>
        <div class="mt-3 text-end">
          <small>الوقت: <span id="timer">0</span> ثانية</small>
        </div>
      </div>

      <!-- Result -->
      <div id="result" class="text-center" style="display:none;">
        <h3 class="mb-4">انتهت المسابقة!</h3>
        <p>الاسم: <span id="resName"></span></p>
        <p>القسم: <span id="resDept"></span></p>
        <p>المستوى: <span id="resLevel"></span></p>
        <p>الدرجة النهائية: <span id="resScore"></span></p>
        <p>الوقت المستغرق: <span id="resTime"></span> ثانية</p>
      </div>
    </div>
  </div>

  <footer>
    <small>المبرمج: مصطفى هاشم</small>
  </footer>

  <script>
    // ✅ استبدل هذا الرابط بـ Web App URL الخاص بك
    const API_URL = "https://script.google.com/macros/s/AKfycbw3OvZkLwSqYaheMOuDkMkUoowisWc62-TG_eIDke825-MMutVl8ang6enhSAn4fOB3/exec";

    let studentInfo = null;
    let questions = [];
    let currentQuestionIndex = 0;
    let score = 0;
    let timerInterval = null;
    let timeElapsed = 0;

    document.getElementById('studentInfo').addEventListener('submit', function (e) {
      e.preventDefault();
      studentInfo = {
        name: document.getElementById('name').value.trim(),
        department: document.getElementById('department').value.trim(),
        level: document.getElementById('level').value
      };
      if (!studentInfo.name || !studentInfo.department || !studentInfo.level) {
        alert("الرجاء تعبئة جميع الحقول");
        return;
      }
      document.getElementById('intro').style.display = 'none';
      document.getElementById('quiz').style.display = 'block';
      startQuiz();
    });

    async function startQuiz() {
      try {
        const res = await fetch(API_URL + "?action=getQuestions");
        if (!res.ok) throw new Error("فشل تحميل الأسئلة");
        questions = await res.json();
        if (questions.length === 0) throw new Error("لا توجد أسئلة");

        currentQuestionIndex = 0;
        score = 0;
        timeElapsed = 0;
        document.getElementById('timer').textContent = timeElapsed;
        timerInterval = setInterval(() => {
          timeElapsed++;
          document.getElementById('timer').textContent = timeElapsed;
        }, 1000);
        showQuestion();
      } catch (err) {
        alert("خطأ: " + err.message);
      }
    }

    function showQuestion() {
      const q = questions[currentQuestionIndex];
      const total = questions.length;
      document.getElementById('questionCounter').textContent = `السؤال ${currentQuestionIndex + 1} من ${total}`;
      document.getElementById('questionText').textContent = q.question;
      const optionsDiv = document.getElementById('options');
      optionsDiv.innerHTML = '';
      q.options.forEach((opt, idx) => {
        const btn = document.createElement('button');
        btn.className = 'btn option-btn w-100 mb-2';
        btn.textContent = opt;
        btn.onclick = () => handleAnswer(idx + 1, q.correct, q.points);
        optionsDiv.appendChild(btn);
      });
    }

    function handleAnswer(selected, correct, points) {
      const buttons = document.querySelectorAll('.option-btn');
      buttons.forEach(btn => btn.disabled = true);

      // تلوين الصحيح بالأخضر
      if (buttons[correct - 1]) {
        buttons[correct - 1].classList.remove('option-btn');
        buttons[correct - 1].classList.add('btn-success');
      }

      // تلوين الخطأ بالأحمر
      if (selected != correct && buttons[selected - 1]) {
        buttons[selected - 1].classList.remove('option-btn');
        buttons[selected - 1].classList.add('btn-danger');
      }

      if (selected == correct) score += points;

      setTimeout(() => {
        currentQuestionIndex++;
        if (currentQuestionIndex < questions.length) {
          showQuestion();
        } else {
          finishQuiz();
        }
      }, 2000);
    }

    function finishQuiz() {
  clearInterval(timerInterval);
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('result').style.display = 'block';

  document.getElementById('resName').textContent = studentInfo.name;
  document.getElementById('resDept').textContent = studentInfo.department;
  document.getElementById('resLevel').textContent = studentInfo.level;
  document.getElementById('resScore').textContent = score;
  document.getElementById('resTime').textContent = timeElapsed;

  // ✅ إرسال النتيجة إلى Google Apps Script
  fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      action: 'submitResult',
      name: studentInfo.name,
      department: studentInfo.department,
      level: studentInfo.level,
      score: score,
      time: timeElapsed
    })
  })
  .then(res => res.text())
  .then(msg => {
    console.log("✅ النتيجة حُفظت:", msg);
    // لا حاجة لتنبيه — يكفي أن تظهر شاشة النتائج
  })
  .catch(err => {
    console.error("❌ فشل الحفظ:", err);
    alert("⚠️ لم تُحفظ نتيجتك. تحقق من الخادم.");
  });
}
  </script>

</body>

</html>